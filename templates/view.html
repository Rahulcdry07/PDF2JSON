<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>View {{ jsonname }}</title>
    <style>
      pre { white-space: pre-wrap; font-family: monospace; }
      .highlight { background-color: #ffff00; color: #000; font-weight: bold; padding: 1px 2px; }
      .highlight-match { background-color: #ff4444; color: white; padding: 2px 4px; border-radius: 3px; font-weight: bold; }
      #searchInput { margin-bottom: 10px; padding: 5px; width: 300px; }
      
      /* Layout for main content and sidebar */
      .container {
        display: flex;
        position: relative;
      }
      
      .main-content {
        flex: 1;
        padding-right: 320px; /* Space for sidebar */
      }
      
      .sidebar {
        position: fixed;
        right: 20px;
        top: 100px;
        width: 280px;
        max-height: 70vh;
        overflow-y: auto;
        background: #f8f9fa;
        border: 2px solid #007bff;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
      }
      
      .sidebar h4 {
        margin-top: 0;
        color: #333;
        font-size: 16px;
      }
      
      .match-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      
      .match-item {
        padding: 8px 12px;
        margin-bottom: 5px;
        background: white;
        border: 1px solid #eee;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s;
        font-size: 14px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .match-item:hover {
        background: #e3f2fd;
        border-color: #2196f3;
      }
      
      .match-item.active {
        background: #ff4444;
        color: white;
        border-color: #cc0000;
      }
      
      .match-number {
        font-weight: bold;
        margin-right: 8px;
      }
      
      /* Go to top button */
      #goToTopBtn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background: #2196f3;
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        transition: all 0.3s;
        z-index: 1000;
        display: none;
      }
      
      #goToTopBtn:hover {
        background: #1976d2;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      }
      
      .no-matches {
        color: #666;
        font-style: italic;
        text-align: center;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <h1>{{ jsonname }}</h1>
    <p><a href="/">Back</a></p>
    <p><a href="/download/{{ jsonname }}">Download JSON</a></p>

    <div class="container">
      <div class="main-content">
        <h2>Search JSON File</h2>
        <form action="/view/{{ jsonname }}" method="get">
          <input type="text" name="search" placeholder="Enter keyword to search the file..." style="width: 300px; padding: 5px;" />
          <input type="submit" value="Search File" />
        </form>
        
        <h3>Real-time Search</h3>
        <input type="text" id="searchInput" placeholder="Type to search instantly..." style="width: 300px; padding: 5px; margin-bottom: 10px;" oninput="searchText()" />

        <h2>JSON Content</h2>
        <pre id="jsonContent">{{ json_content }}</pre>
      </div>
      
      <div class="sidebar" id="searchSidebar" style="display: none;">
        <h4>Search Results</h4>
        <div id="matchCount">No search term entered</div>
        <ul id="matchList" class="match-list"></ul>
      </div>
    </div>

    <!-- Go to Top Button -->
    <button id="goToTopBtn" title="Go to Top">â†‘</button>

    <script>
      // Store original text content
      let originalText = '';
      
      function searchText() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
        const content = document.getElementById('jsonContent');
        const sidebar = document.getElementById('searchSidebar');
        const matchList = document.getElementById('matchList');
        const matchCount = document.getElementById('matchCount');
        
        // Store original text if not already stored
        if (!originalText) {
          originalText = content.textContent || content.innerText;
        }
        
        const text = originalText;

        if (searchTerm === '') {
          content.innerHTML = originalText;
          sidebar.style.display = 'none';
          return;
        }

        try {
          const regex = new RegExp(searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
          const matches = text.match(regex) || [];
          const matchCountNum = matches.length;
          
          if (matchCountNum > 0) {
            // Highlight matches
            let currentMatchIndex = 0;
            const highlightedText = text.replace(regex, function(match) {
              currentMatchIndex++;
              if (currentMatchIndex === 1) {
                return `<span class="highlight-match" data-match-id="${currentMatchIndex}">${match}</span>`;
              } else {
                return `<span class="highlight" data-match-id="${currentMatchIndex}">${match}</span>`;
              }
            });
            
            content.innerHTML = highlightedText;
            
            // Update sidebar
            matchCount.textContent = `${matchCountNum} match${matchCountNum === 1 ? '' : 'es'} found`;
            matchList.innerHTML = '';
            
            matches.forEach((matchText, index) => {
              const li = document.createElement('li');
              li.className = 'match-item';
              li.setAttribute('data-match-id', index + 1);
              li.innerHTML = `<span class="match-number">${index + 1}.</span> ${matchText.substring(0, 50)}${matchText.length > 50 ? '...' : ''}`;
              
              li.addEventListener('click', function() {
                scrollToMatch(index + 1);
              });
              
              matchList.appendChild(li);
            });
            
            sidebar.style.display = 'block';
          } else {
            content.innerHTML = originalText;
            matchCount.textContent = 'No matches found';
            matchList.innerHTML = '<li class="no-matches">No matches found</li>';
            sidebar.style.display = 'block';
          }
        } catch (e) {
          console.error('Search error:', e);
          matchCount.textContent = 'Search error';
          sidebar.style.display = 'block';
        }
        
        // Scroll to the first match
        setTimeout(function() {
          const firstMatch = document.querySelector('.highlight-match');
          if (firstMatch) {
            firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 100);
      }

      function scrollToMatch(matchId) {
        const matchElement = document.querySelector(`[data-match-id="${matchId}"]`);
        if (matchElement) {
          // Remove active class from all items
          document.querySelectorAll('.match-item').forEach(item => {
            item.classList.remove('active');
          });
          
          // Add active class to clicked item
          const listItem = document.querySelector(`.match-item[data-match-id="${matchId}"]`);
          if (listItem) {
            listItem.classList.add('active');
          }
          
          matchElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }

      // Initialize on page load
      window.addEventListener('DOMContentLoaded', function() {
        // Store original content
        const content = document.getElementById('jsonContent');
        if (content) {
          originalText = content.textContent || content.innerText;
        }
        
        // Check if there's a search term from server-side search
        const urlParams = new URLSearchParams(window.location.search);
        const serverSearchTerm = urlParams.get('search');
        
        if (serverSearchTerm) {
          // Set the search input and trigger highlighting
          const searchInput = document.getElementById('searchInput');
          if (searchInput) {
            searchInput.value = serverSearchTerm;
            searchText();
          }
        }
        
        // Scroll to the first match
        setTimeout(function() {
          const highlightMatch = document.querySelector('.highlight-match');
          if (highlightMatch) {
            highlightMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 300);
      });

      // Go to top button functionality
      window.addEventListener('scroll', function() {
        const goToTopBtn = document.getElementById('goToTopBtn');
        if (window.pageYOffset > 300) {
          goToTopBtn.style.display = 'block';
        } else {
          goToTopBtn.style.display = 'none';
        }
      });

      document.getElementById('goToTopBtn').addEventListener('click', function() {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    </script>
  </body>
</html>
