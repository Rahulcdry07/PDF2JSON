<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>DSR Cost Report - {{ filename }}</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background-color: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 30px;
      }
      .back-btn {
        background-color: #6c757d;
        color: white;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        display: inline-block;
        margin-bottom: 20px;
      }
      .back-btn:hover {
        background-color: #545b62;
      }
      .project-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
      }
      .project-info h3 {
        margin-top: 0;
        color: #007bff;
      }
      .project-info p {
        margin: 5px 0;
        font-size: 14px;
        color: #666;
      }
      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 6px;
        margin-bottom: 30px;
      }
      .summary-item {
        text-align: center;
        padding: 15px;
        background-color: white;
        border-radius: 6px;
        border: 1px solid #dee2e6;
      }
      .summary-value {
        font-size: 28px;
        font-weight: bold;
        color: #007bff;
      }
      .summary-label {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
      .items-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: white;
      }
      .items-table th,
      .items-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
      }
      .items-table th {
        background-color: #007bff;
        color: white;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .items-table tr:hover {
        background-color: #f8f9fa;
      }
      .match-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        text-transform: uppercase;
        white-space: nowrap;
      }
      .match-exact { background-color: #d4edda; color: #155724; }
      .match-partial { background-color: #fff3cd; color: #856404; }
      .match-not-found { background-color: #f8d7da; color: #721c24; }
      .amount-cell {
        text-align: right;
        font-weight: bold;
      }
      .amount-positive {
        color: #28a745;
      }
      .description-cell {
        max-width: 300px;
      }
      .dsr-description {
        font-size: 12px;
        color: #666;
        font-style: italic;
        margin-top: 3px;
      }
      .total-row {
        background-color: #f8f9fa;
        font-weight: bold;
        border-top: 3px solid #007bff;
      }
      .total-row td {
        padding: 15px 12px;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <a href="/" class="back-btn">‚Üê Back to Files</a>
      <a href="/cost-estimation" class="back-btn">üìä New Estimation</a>
      
      <h1>üìÑ DSR Cost Report</h1>
      
      <div class="project-info">
        <h3>{{ report.project }}</h3>
        <p><strong>Input File:</strong> {{ report.source_files['items'].split('/')[-1] }}</p>
        <p><strong>Database:</strong> {{ report.source_files['rates_database'].split('/')[-1] }}</p>
      </div>
      
      <div class="summary-grid">
        <div class="summary-item">
          <div class="summary-value">{{ report.summary.total_items }}</div>
          <div class="summary-label">Total Items</div>
        </div>
        <div class="summary-item">
          <div class="summary-value">{{ report.summary.exact_matches }}</div>
          <div class="summary-label">Exact Matches</div>
        </div>
        <div class="summary-item">
          <div class="summary-value">{{ report.summary.code_match_description_mismatch }}</div>
          <div class="summary-label">Partial Matches</div>
        </div>
        <div class="summary-item">
          <div class="summary-value">{{ report.summary.not_found }}</div>
          <div class="summary-label">Not Found</div>
        </div>
        <div class="summary-item" style="grid-column: span 2;">
          <div class="summary-value" style="color: #28a745;">‚Çπ{{ "%.2f"|format(report.summary.total_estimated_amount) }}</div>
          <div class="summary-label">Total Estimated Amount</div>
        </div>
      </div>
      
      <h2 style="color: #333; margin-top: 30px;">Detailed Items</h2>
      
      <table class="items-table">
        <thead>
          <tr>
            <th>#</th>
            <th>DSR Code</th>
            <th>Description</th>
            <th>Quantity</th>
            <th>Unit</th>
            <th>Rate (‚Çπ)</th>
            <th>Amount (‚Çπ)</th>
            <th>Match Type</th>
            <th>Volume</th>
          </tr>
        </thead>
        <tbody>
          {% for item in report.matched_items %}
          <tr>
            <td>{{ loop.index }}</td>
            <td><strong>{{ item.dsr_code }}</strong></td>
            <td class="description-cell">
              <div>{{ item.description }}</div>
              {% if item.dsr_description %}
              <div class="dsr-description">DSR: {{ item.dsr_description }}</div>
              {% endif %}
            </td>
            <td style="text-align: right;">{{ item.quantity }}</td>
            <td>{{ item.unit }}</td>
            <td class="amount-cell">{{ "%.2f"|format(item.rate) if item.rate else '-' }}</td>
            <td class="amount-cell amount-positive">
              {{ "%.2f"|format(item.amount) if item.amount else '-' }}
            </td>
            <td>
              {% if item.match_type == 'exact_match' or item.match_type == 'exact_with_description_match' %}
                <span class="match-badge match-exact">Exact</span>
              {% elif 'code_match' in item.match_type %}
                <span class="match-badge match-partial">Partial</span>
              {% else %}
                <span class="match-badge match-not-found">Not Found</span>
              {% endif %}
              {% if item.similarity_score %}
              <br><small style="color: #666;">{{ "%.0f"|format(item.similarity_score * 100) }}%</small>
              {% endif %}
            </td>
            <td>{{ item.dsr_volume }}</td>
          </tr>
          {% endfor %}
          <tr class="total-row">
            <td colspan="6" style="text-align: right;">TOTAL AMOUNT:</td>
            <td class="amount-cell" style="color: #28a745; font-size: 18px;">
              ‚Çπ{{ "%.2f"|format(report.summary.total_estimated_amount) }}
            </td>
            <td colspan="2"></td>
          </tr>
        </tbody>
      </table>
      
      <div style="margin-top: 30px; padding: 20px; background-color: #f8f9fa; border-radius: 6px; text-align: center;">
        <p style="margin: 0; color: #666;">
          <strong>Report File:</strong> {{ filename }}
        </p>
      </div>
    </div>
  </body>
</html>
